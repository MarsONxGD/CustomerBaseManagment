# SoftwareCBM

Программа для автоматического распознавания заявок клиентов по электронной почте, их классификации и проверки наличия
артикулов в тексте для дальнейшей обработки.

- [Основной функционал](#основной-функционал)
- [Настройка](#настройка)
    - [Почтовый клиент](#1-почтовый-клиент)
    - [Классификатор писем](#2-классификатор-писем)
    - [Проверка артикулов](#3-проверка-артикулов)
- [Запуск системы](#запуск-системы)
    - [Интерактивный режим](#1-интерактивный-режим-cli)
    - [Автоматический режим](#2-автоматический-режим)
    - [Прямой запуск](#3-прямой-запуск-обработчика)
- [Структура проета](#структура-проекта)
- [Процесс обработки письма](#процесс-обработки-письма)
- [Пример работы](#пример-работы)
- [Устранение неисправностей](#устранение-неисправностей)
    - [Частые проблемы](#частые-проблемы-и-решения)
    - [Логирование](#логирование)

### Быстрый старт

1. Клонируйте репозиторий: `git clone https://github.com/MarsONxGD/CustomerBaseManagment.git`
2. Установите зависимости: `pip install -r requirements.txt`
3. Настройте `config/email_config.py` (IMAP-хост, логин, пароль).
4. Обучите/загрузите модель: `python src/email_classifier/train.py`
5. Запустите: `python src/customer_base_management.py`

## Основной функционал

- **Сбор писем**: Подключение к почтовому ящику по IMAP и сбор непрочитанных писем
- **Классификация писем**: Автоматическое определение, является ли письмо заявкой от клиента с использованием LSTM-модели
- **Проверка артикулов**: Поиск и валидация артикулов в тексте писем и вложений
- **Обработка вложений**: Извлечение текста из различных форматов файлов (PDF, DOCX, XLSX и др.)
- **Логирование**: Подробное ведение логов работы системы
- **Автоматический режим**: Непрерывный мониторинг почтового ящика с настраиваемым интервалом

## Настройка

### 1. Почтовый клиент

Для настройки почты создайте файл `<ProgramPath>/config/email_config.py` со следующим содержимым:

```python
# <ProgramPath>/config/email_config.py
def credentials():
    config = {
        'email': 'example@email.com',
        'password': '0123456789abcdefghij',
        'imap_server': 'imap.email.com',
        'imap_port': 993
    }
    return config
```

#### Описание параметров

- `email` - адрес электронной почты
- `password` - пароль от почтового ящика или специальный пароль приложения
- `imap_server` - адрес IMAP сервера для получения почты
- `imap_port` - порт IMAP сервера (обычно 993 для SSL)

### 2. Классификатор писем

#### Обучение модели

Поддерживается автоматический сбор датасета из заранее подготовленных писем в почте:
1. Создайте в почте 2 папка: `DATASET/TRUE`, `DATASET/FALSE`
2. Рассортируйте ваши заявки и спам по этим папкам
3. Запустите скрипт `python src/tools/dataset_collector.py`
Данный скрипт сохраняет предыдущую версию датасета и создает новую объединяя данные из почты и старой версии

Для обучения классификатора нужно создать 2 датасета:

- `<ProgramPath>/datasets/data.csv` - для обучения модели
- `<ProgramPath>/datasets/test_data.csv` - для вычисления метрик

Также файлы можно создають данным скриптом, или любым другим по этому шаблону:

```python
# <ProjectPath>/datasets/create_data.py
import pandas as pd

data = [
    {"text": "Заявка #1", "label": 1},
    # ...
    {"text": "Заявка #N", "label": 1},
    {"text": "Не заявка #1", "label": 0},
    # ...
    {"text": "Не заявка #N", "label": 0}
]

df = pd.DataFrame(data)
df.to_csv("data.csv", index=False, encoding="utf-8-sig")

print("Файл data.csv успешно создан!")
print(f"Всего примеров: {len(df)}")
print(f"Заявок (1): {len(df[df['label'] == 1])}")
print(f"Не заявок (0): {len(df[df['label'] == 0])}")
```

#### Обучение и оценка модели

- Файл `<ProgramPath>/src/email_classifier/train.py` отвечает за обучение модели
- Файл `<ProgramPath>/src/email_classifier/metrics.py` отвечает за расчет метрик

### 3. Проверка артикулов

#### Настройка справочника артикулов

Для задания артикулов создайте файл `<ProgramPath>/config/articles.json` со следующим содержимым:

```json
[
  "AAA-001",
  "AAA-002",
  "ZZZ-998",
  "ZZZ-999"
]
```

#### Описание параметров

- `AAA-001` - Пример артикула, замените на свои значения

#### Формат артикулов

Система поддерживает артикулы в произвольных форматах

## Запуск системы

### 1. Интерактивный режим (CLI)

Запустите скрипт для начала обработки писем - `python src/customer_base_management.py`

Он представляет из себя CLI с набором команд

- **receive-mail** - Получить новые письма
- **receive-mail-force** - Принудительно получить все письма
- **show-results** - Показать найденные заявки
- **show-articles** - Показать загруженные артикулы
- **show-apps <дни>** - Показывать заявки по дате (по умолчанию 180 дней)
- **cleanup-logs** - Очистить логи
- **cleanup-temp** - Очистить временные данные
- **cleanup-all** - Очистить всё
- **status** - Показать статус системы
- **help** - Показать эту справку
- **exit** - Выход

### 2. Автоматический режим

Запустите скрипт для начала непрерывного мониторинга почтового ящика - `python src/cbm_automode.py`

#### Особенности автоматического режима

- Настраиваемый интервал проверки
- Статистика по историческим данным
- Автоматическое переподключение при ошибках
- Детальное логирование каждого цикла

### 3. Прямой запуск обработчика

Для интеграции с другими системами:

- `python src/tools/email_handler.py` - Обычный режим
- `python src/tools/email_handler.py --force` - Форсированный режим

## Структура проекта

```
<ProgramPath>/
├── config/
│   ├── email_config.py               # Настройки почтового соединения
│   └── articles.json                 # Справочник артикулов для поиска
├── datasets/
│   ├── data.csv                      # Тренировочные данные для модели
│   └── test_data.csv                 # Тестовые данные для валидации
├── log/
│   ├── train.log                     # Логи процесса обучения модели
│   ├── dataset_collector.log         # Логи сборщика датасета
│   └── softwarecbm.log               # Основной лог работы системы
├── models/
│   ├── email_classifier.pth          # Веса обученной нейросети
│   └── vocabulary.json               # Словарь токенов для модели
├── src/
│   ├── email_classifier/
│   │   ├── metrics.py                # Расчет метрик качества модели
│   │   ├── model.py                  # Архитектура LSTM-модели
│   │   ├── predict.py                # Модуль предсказаний
│   │   └── train.py                  # Скрипт обучения модели
│   ├── tools/
│   │   ├── ANSIColorFormatter.py     # Форматировщик цветного вывода
│   │   ├── article_matcher.py        # Поиск артикулов в тексте
│   │   ├── attachment_processor.py   # Обработчик вложений
│   │   ├── dataset_collector.py      # Сборщик тренировочных данных
│   │   └── email_handler.py          # Основной обработчик писем
│   ├── cbm_automode.py               # Автоматический режим работы
│   └── customer_base_management.py   # Интерактивный CLI
├── temp/
│   ├── email/                        # Временное хранение писем
│   │   └── attachments/              # Временные файлы вложений
│   └── results/                      # Результаты обработки
│       └── applications.csv          # База данных обработанных заявок
├── .gitignore
├── README.md
└── requirements.txt
```

## Процесс обработки письма

1. Получение письма - подключение к IMAP, получение непрочитанных писем
2. Парсинг - извлечение текста, темы, отправителя и вложений
3. Классификация - определение является ли письмо заявкой с помощью ML-модели
4. Поиск артикулов - проверка текста и вложений на наличие артикулов из справочника
5. Сортировка - перемещение письма в соответствующую папку:
    - `PROCESSED/CORRECT` - заявки с артикулами
    - `PROCESSED/INCORRECT` - заявки без артикулов
    - `PROCESSED/SPAM` - не заявки
6. Сохранение результатов - запись информации о заявке в CSV и JSON форматах

## Пример работы

При получении нового письма система:

1. **Подключается** к почтовому серверу и получает письмо
2. **Анализирует** текст и вложения письма
3. **Классифицирует** письмо (заявка/не заявка) с указанием уверенности
4. **Ищет** артикулы в тексте и извлеченном содержимом вложений
5. **Сохраняет** результаты и перемещает письмо в соответствующую папку
6. **Формирует** отчет с детальной информацией о обработке

## Устранение неисправностей

### Частые проблемы и решения

1. **Ошибки подключения к почте**
    - Проверьте настройки IMAP в `email_config.py`
    - Убедитесь, что включен доступ по IMAP
2. **Проблемы с классификацией**
    - Проверьте качество тренировочных данных
    - Запустите расчет метрик для диагностики модели
    - Убедитесь в сбалансированности классов
3. **Ошибки обработки вложений**
    - Проверьте установленные зависимости для обработки файлов
    - Убедитесь, что файлы не повреждены и не защищены паролем

### Логирование

Система ведет подробные логи включая:

- Процесс подключения к почтовому серверу
- Статистику по обработанным письмам
- Результаты классификации
- Найденные артикулы
- Ошибки и предупреждения

Основные файлы логов:

- `log/softwarecbm.log` - основной лог обработки писем
- `log/train.log` - основной лог обработки писем
- `log/dataset_collector.log` - основной лог обработки писем
